{% extends "base.html" %}

{% block title %}Registro - Econova{% endblock %}

{% block head %}
<style>
@keyframes highlight {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
  100% { transform: scale(1); }
}
</style>
{% endblock %}

{% block content %}
<!-- Registration Hero -->
<section class="bg-white text-gray-900 py-24 relative overflow-hidden">
  <!-- Elementos decorativos sutiles -->
  <div class="absolute inset-0 opacity-3">
    <div class="absolute top-20 left-10 w-32 h-32 border-2 border-blue-200 rounded-full"></div>
    <div class="absolute top-40 right-20 w-24 h-24 border border-blue-300 rounded-lg rotate-45"></div>
    <div class="absolute bottom-32 left-1/4 w-16 h-16 bg-blue-100 rounded-full"></div>
  </div>

  <div class="container mx-auto px-6 text-center relative">
    <h1 class="text-h1 mb-6 font-heading animate-hero-title">
      Ãšnete a Econova
    </h1>
    <p class="text-body-lg text-gray-600 mb-8 max-w-2xl mx-auto font-primary">
      Crea tu cuenta gratuita y comienza a optimizar tus decisiones financieras
      con herramientas de IA avanzadas
    </p>
    <div class="flex items-center justify-center space-x-8 text-sm animate-hero-metrics">
      <div class="flex items-center text-green-600">
        <i class="fas fa-check-circle mr-2"></i>
        <span class="font-primary font-medium">100% Gratuito</span>
      </div>
      <div class="flex items-center text-blue-600">
        <i class="fas fa-check-circle mr-2"></i>
        <span class="font-primary font-medium">Sin compromiso</span>
      </div>
      <div class="flex items-center text-purple-600">
        <i class="fas fa-check-circle mr-2"></i>
        <span class="font-primary font-medium">ConfiguraciÃ³n rÃ¡pida</span>
      </div>
    </div>
  </div>
</section>

<!-- Registration Form -->
<section class="py-16 bg-gray-50">
  <div class="container mx-auto px-6">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-8 md:p-12">

        <!-- Progress Indicator -->
        <div class="mb-8">
          <div class="flex items-center justify-center space-x-4">
            <div class="flex items-center">
              <div id="step-1-circle" class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold transition-colors duration-300">
                1
              </div>
              <span id="step-1-label" class="ml-2 text-gray-700 font-medium transition-colors duration-300">Cuenta</span>
            </div>
            <div id="step-1-line" class="w-12 h-0.5 bg-gray-300 transition-colors duration-300"></div>
            <div class="flex items-center">
              <div id="step-2-circle" class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold transition-colors duration-300">
                2
              </div>
              <span id="step-2-label" class="ml-2 text-gray-400 transition-colors duration-300">Perfil</span>
            </div>
            <div id="step-2-line" class="w-12 h-0.5 bg-gray-300 transition-colors duration-300"></div>
            <div class="flex items-center">
              <div id="step-3-circle" class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold transition-colors duration-300">
                3
              </div>
              <span id="step-3-label" class="ml-2 text-gray-400 transition-colors duration-300">Empresa</span>
            </div>
            <div id="step-3-line" class="w-12 h-0.5 bg-gray-300 transition-colors duration-300"></div>
            <div class="flex items-center">
              <div id="step-4-circle" class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold transition-colors duration-300">
                4
              </div>
              <span id="step-4-label" class="ml-2 text-gray-400 transition-colors duration-300">TÃ©rminos</span>
            </div>
          </div>
        </div>

        <!-- Form -->
        <form id="registration-form" method="POST" class="space-y-6">

          <!-- Step 1: Personal Information -->
          <div id="step-1" class="form-step">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-user mr-2 text-blue-600"></i>
              InformaciÃ³n Personal
            </h3>

            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label for="nombres" class="block text-sm font-medium text-gray-700 mb-2">
                  Nombres *
                </label>
                <input
                  type="text"
                  id="nombres"
                  name="nombres"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                  placeholder="Juan Carlos"
                >
              </div>

              <div>
                <label for="apellidos" class="block text-sm font-medium text-gray-700 mb-2">
                  Apellidos *
                </label>
                <input
                  type="text"
                  id="apellidos"
                  name="apellidos"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                  placeholder="PÃ©rez RodrÃ­guez"
                >
              </div>
            </div>

            <div class="mt-6">
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                Correo ElectrÃ³nico *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                placeholder="juan.perez@email.com"
              >
            </div>

            <div class="mt-6">
              <label for="telefono" class="block text-sm font-medium text-gray-700 mb-2">
                TelÃ©fono
              </label>
              <input
                type="tel"
                id="telefono"
                name="telefono"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                placeholder="+51 999 999 999"
              >
            </div>
          </div>

          <!-- Step 2: Account Information -->
          <div id="step-2" class="form-step hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-lock mr-2 text-blue-600"></i>
              InformaciÃ³n de Cuenta
            </h3>

            <div>
              <label for="nombre_usuario" class="block text-sm font-medium text-gray-700 mb-2">
                Nombre de Usuario *
              </label>
              <input
                type="text"
                id="nombre_usuario"
                name="nombre_usuario"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                placeholder="juanperez2025"
              >
              <p class="text-xs text-gray-500 mt-1">Este serÃ¡ tu nombre de usuario Ãºnico</p>
            </div>

            <div class="mt-6">
              <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                ContraseÃ±a *
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  name="password"
                  required
                  class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                >
                <button type="button" id="toggle-password" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="mt-2">
                <div class="text-xs text-gray-600 space-y-1">
                  <div class="flex items-center">
                    <i class="fas fa-check text-green-500 mr-2 text-xs" id="length-check"></i>
                    <span>MÃ­nimo 8 caracteres</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-check text-green-500 mr-2 text-xs" id="number-check"></i>
                    <span>Al menos un nÃºmero</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-check text-green-500 mr-2 text-xs" id="special-check"></i>
                    <span>Al menos un carÃ¡cter especial</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-6">
              <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">
                Confirmar ContraseÃ±a *
              </label>
              <input
                type="password"
                id="confirm_password"
                name="confirm_password"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              >
            </div>
          </div>

          <!-- Step 3: Business Information -->
          <div id="step-3" class="form-step hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-building mr-2 text-blue-600"></i>
              InformaciÃ³n Empresarial
            </h3>

            <div>
              <label for="empresa" class="block text-sm font-medium text-gray-700 mb-2">
                Nombre de la Empresa
              </label>
              <input
                type="text"
                id="empresa"
                name="empresa"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                placeholder="Mi Empresa S.A.C."
              >
            </div>

            <div class="mt-6">
              <label for="sector" class="block text-sm font-medium text-gray-700 mb-2">
                Sector Empresarial
              </label>
              <select
                id="sector"
                name="sector"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              >
                <option value="">Seleccionar sector</option>
                <option value="manufactura">Manufactura e Industria</option>
                <option value="comercio">Comercio y Retail</option>
                <option value="servicios">Servicios</option>
                <option value="tecnologia">TecnologÃ­a</option>
                <option value="construccion">ConstrucciÃ³n</option>
                <option value="agricultura">Agricultura</option>
                <option value="turismo">Turismo y Hospitalidad</option>
                <option value="financiero">Servicios Financieros</option>
                <option value="salud">Salud</option>
                <option value="educacion">EducaciÃ³n</option>
                <option value="otro">Otro</option>
              </select>
            </div>

            <div class="mt-6">
              <label for="tamano_empresa" class="block text-sm font-medium text-gray-700 mb-2">
                TamaÃ±o de la Empresa
              </label>
              <select
                id="tamano_empresa"
                name="tamano_empresa"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
              >
                <option value="">Seleccionar tamaÃ±o</option>
                <option value="micro">Microempresa (1-10 empleados)</option>
                <option value="pequena">PequeÃ±a (11-50 empleados)</option>
                <option value="mediana">Mediana (51-200 empleados)</option>
                <option value="grande">Grande (201+ empleados)</option>
                <option value="emprendedor">Emprendedor Individual</option>
              </select>
            </div>
          </div>

          <!-- Step 4: Terms and Conditions -->
          <div id="step-4" class="form-step hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-file-contract mr-2 text-blue-600"></i>
              TÃ©rminos y Condiciones
            </h3>

            <div class="flex items-start">
              <input
                type="checkbox"
                id="terminos"
                name="terminos"
                required
                class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              >
              <label for="terminos" class="ml-3 text-sm text-gray-700">
                Acepto los <a href="/terminos" class="text-blue-600 hover:text-blue-800">TÃ©rminos y Condiciones</a>
                y la <a href="/privacidad" class="text-blue-600 hover:text-blue-800">PolÃ­tica de Privacidad</a> *
              </label>
            </div>

            <div class="flex items-start mt-4">
              <input
                type="checkbox"
                id="newsletter"
                name="newsletter"
                class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              >
              <label for="newsletter" class="ml-3 text-sm text-gray-700">
                Deseo recibir actualizaciones y consejos financieros por email
              </label>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div class="flex justify-between pt-6">
            <button
              type="button"
              id="prev-btn"
              class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 focus:ring-4 focus:ring-gray-300 transition duration-300 hidden"
            >
              <i class="fas fa-arrow-left mr-2"></i>
              Anterior
            </button>

            <button
              type="button"
              id="next-btn"
              class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition duration-300"
            >
              Siguiente
              <i class="fas fa-arrow-right ml-2"></i>
            </button>

            <button
              type="submit"
              id="submit-btn"
              class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-300 transition duration-300 hidden"
            >
              <i class="fas fa-user-plus mr-2"></i>
              Crear Mi Cuenta Gratuita
            </button>
          </div>

          <!-- Login Link -->
          <div class="text-center pt-4">
            <p class="text-gray-600">
              Â¿Ya tienes cuenta?
          <a href="/api/v1/login" class="text-blue-600 hover:text-blue-800 font-medium">Inicia sesiÃ³n aquÃ­</a>
            </p>
          </div>
        </form>

        <!-- Success/Error Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div id="flash-message" class="mt-6 p-6 rounded-lg {% if category == 'error' %}bg-red-50 text-red-800 border-2 border-red-200{% else %}bg-green-50 text-green-800 border-2 border-green-200{% endif %}">
                <div class="flex items-center">
                  <i class="fas {% if category == 'error' %}fa-exclamation-triangle{% else %}fa-check-circle{% endif %} text-2xl mr-3"></i>
                  <div>
                    <h3 class="font-semibold text-lg mb-1">
                      {% if category == 'error' %}Error en el registro{% else %}Â¡Registro exitoso!{% endif %}
                    </h3>
                    <p class="text-sm">{{ message }}</p>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div id="message" class="mt-6 hidden">
          <div class="p-4 rounded-lg" id="message-content"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Benefits Section -->
<section class="py-16 bg-white">
  <div class="container mx-auto px-6">
    <div class="text-center mb-12">
      <h2 class="text-3xl font-bold text-gray-800 mb-4">
        Â¿Por quÃ© registrarte en Econova?
      </h2>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Accede a herramientas avanzadas que transformarÃ¡n la forma en que tomas decisiones financieras
      </p>
    </div>

    <div class="grid md:grid-cols-3 gap-8">
      <div class="text-center">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-brain text-blue-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">IA Avanzada</h3>
        <p class="text-gray-600 text-sm">Algoritmos de machine learning para predicciones precisas</p>
      </div>

      <div class="text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-chart-line text-green-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">AnÃ¡lisis Completo</h3>
        <p class="text-gray-600 text-sm">VAN, TIR, WACC y anÃ¡lisis de portafolio en tiempo real</p>
      </div>

      <div class="text-center">
        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-users text-purple-600 text-2xl"></i>
        </div>
        <h3 class="font-semibold text-gray-800 mb-2">Comunidad</h3>
        <p class="text-gray-600 text-sm">Comparte experiencias y aprende de otros empresarios</p>
      </div>
    </div>
  </div>
</section>

<script>
// Scroll to flash message if it exists
document.addEventListener('DOMContentLoaded', function() {
  const flashMessage = document.getElementById('flash-message');
  if (flashMessage) {
    flashMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
    // Add a highlight effect
    flashMessage.style.animation = 'highlight 2s ease-in-out';
  }
});

// Password visibility toggle
document.getElementById('toggle-password').addEventListener('click', function() {
  const passwordInput = document.getElementById('password');
  const icon = this.querySelector('i');

  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    passwordInput.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
});

// Password strength validation
document.getElementById('password').addEventListener('input', function() {
  const password = this.value;
  const lengthCheck = document.getElementById('length-check');
  const numberCheck = document.getElementById('number-check');
  const specialCheck = document.getElementById('special-check');

  // Length check
  if (password.length >= 8) {
    lengthCheck.classList.remove('fa-times', 'text-red-500');
    lengthCheck.classList.add('fa-check', 'text-green-500');
  } else {
    lengthCheck.classList.remove('fa-check', 'text-green-500');
    lengthCheck.classList.add('fa-times', 'text-red-500');
  }

  // Number check
  if (/\d/.test(password)) {
    numberCheck.classList.remove('fa-times', 'text-red-500');
    numberCheck.classList.add('fa-check', 'text-green-500');
  } else {
    numberCheck.classList.remove('fa-check', 'text-green-500');
    numberCheck.classList.add('fa-times', 'text-red-500');
  }

  // Special character check
  if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
    specialCheck.classList.remove('fa-times', 'text-red-500');
    specialCheck.classList.add('fa-check', 'text-green-500');
  } else {
    specialCheck.classList.remove('fa-check', 'text-green-500');
    specialCheck.classList.add('fa-times', 'text-red-500');
  }
});

// Multi-step form wizard
let currentStep = 1;
const totalSteps = 4;

function showStep(step) {
  // Hide all steps
  document.querySelectorAll('.form-step').forEach(stepDiv => {
    stepDiv.classList.add('hidden');
  });

  // Show current step
  document.getElementById(`step-${step}`).classList.remove('hidden');

  // Update progress indicator
  updateProgressIndicator(step);

  // Update navigation buttons
  updateNavigationButtons(step);
}

function updateProgressIndicator(step) {
  // Reset all circles and labels
  for (let i = 1; i <= totalSteps; i++) {
    const circle = document.getElementById(`step-${i}-circle`);
    const label = document.getElementById(`step-${i}-label`);
    const line = document.getElementById(`step-${i}-line`);

    if (i <= step) {
      // Active/completed steps
      circle.classList.remove('bg-gray-300', 'text-gray-600');
      circle.classList.add('bg-blue-600', 'text-white');
      label.classList.remove('text-gray-400');
      label.classList.add('text-gray-700', 'font-medium');
      if (line) {
        line.classList.remove('bg-gray-300');
        line.classList.add('bg-blue-600');
      }
    } else {
      // Inactive steps
      circle.classList.remove('bg-blue-600', 'text-white');
      circle.classList.add('bg-gray-300', 'text-gray-600');
      label.classList.remove('text-gray-700', 'font-medium');
      label.classList.add('text-gray-400');
      if (line) {
        line.classList.remove('bg-blue-600');
        line.classList.add('bg-gray-300');
      }
    }
  }
}

function updateNavigationButtons(step) {
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const submitBtn = document.getElementById('submit-btn');

  // Previous button
  if (step === 1) {
    prevBtn.classList.add('hidden');
  } else {
    prevBtn.classList.remove('hidden');
  }

  // Next/Submit buttons
  if (step === totalSteps) {
    nextBtn.classList.add('hidden');
    submitBtn.classList.remove('hidden');
  } else {
    nextBtn.classList.remove('hidden');
    submitBtn.classList.add('hidden');
  }
}

async function validateStep(step) {
  let isValid = true;
  const errors = [];

  switch (step) {
    case 1: // Personal Information
      const nombres = document.getElementById('nombres').value.trim();
      const apellidos = document.getElementById('apellidos').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!nombres) {
        errors.push('Los nombres son obligatorios');
        isValid = false;
      }
      if (!apellidos) {
        errors.push('Los apellidos son obligatorios');
        isValid = false;
      }
      if (!email) {
        errors.push('El correo electrÃ³nico es obligatorio');
        isValid = false;
      } else if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
        errors.push('El correo electrÃ³nico no es vÃ¡lido');
        isValid = false;
      } else {
        // Check if email already exists
        try {
          const emailCheckResponse = await fetch(`/api/v1/check-email?email=${encodeURIComponent(email)}`);
          const emailCheckData = await emailCheckResponse.json();
          if (!emailCheckData.available) {
            errors.push('Ya existe una cuenta con este correo electrÃ³nico');
            isValid = false;
          }
        } catch (error) {
          console.error('Error checking email:', error);
          // Continue validation even if check fails
        }
      }
      break;

    case 2: // Account Information
      const nombreUsuario = document.getElementById('nombre_usuario').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm_password').value;

      if (!nombreUsuario) {
        errors.push('El nombre de usuario es obligatorio');
        isValid = false;
      } else if (!/^[a-zA-Z0-9_]{3,20}$/.test(nombreUsuario)) {
        errors.push('El nombre de usuario debe tener entre 3-20 caracteres y solo letras, nÃºmeros y guiones bajos');
        isValid = false;
      } else {
        // Check if username already exists
        try {
          const usernameCheckResponse = await fetch(`/api/v1/check-username?username=${encodeURIComponent(nombreUsuario)}`);
          const usernameCheckData = await usernameCheckResponse.json();
          if (!usernameCheckData.available) {
            errors.push('Este nombre de usuario ya estÃ¡ en uso');
            isValid = false;
          }
        } catch (error) {
          console.error('Error checking username:', error);
          // Continue validation even if check fails
        }
      }
      if (!password) {
        errors.push('La contraseÃ±a es obligatoria');
        isValid = false;
      } else if (password.length < 8) {
        errors.push('La contraseÃ±a debe tener al menos 8 caracteres');
        isValid = false;
      } else if (!/\d/.test(password)) {
        errors.push('La contraseÃ±a debe contener al menos un nÃºmero');
        isValid = false;
      } else if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        errors.push('La contraseÃ±a debe contener al menos un carÃ¡cter especial');
        isValid = false;
      }
      if (password !== confirmPassword) {
        errors.push('Las contraseÃ±as no coinciden');
        isValid = false;
      }
      break;

    case 3: // Business Information (optional)
      // No validation required for optional fields
      break;

    case 4: // Terms and Conditions
      const terminos = document.getElementById('terminos').checked;
      if (!terminos) {
        errors.push('Debes aceptar los tÃ©rminos y condiciones');
        isValid = false;
      }
      break;
  }

  if (!isValid) {
    showErrorMessage(errors.join('<br>'));
  } else {
    // Clear any previous error messages when validation passes
    clearErrorMessage();
  }

  return isValid;
}

function showErrorMessage(message) {
  const messageDiv = document.getElementById('message');
  const messageContent = document.getElementById('message-content');

  messageDiv.className = 'mt-6';
  messageContent.className = 'p-4 rounded-lg bg-red-50 text-red-800 border border-red-200';
  messageContent.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>' + message;

  // Scroll to message
  messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function clearErrorMessage() {
  const messageDiv = document.getElementById('message');
  messageDiv.className = 'mt-6 hidden';
}

// Initialize wizard
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸŽ¯ Initializing registration wizard...');
  showStep(currentStep);

  // Next button
  const nextBtn = document.getElementById('next-btn');
  if (nextBtn) {
    console.log('ðŸŽ¯ Next button found, adding event listener');
    nextBtn.addEventListener('click', async function(e) {
      console.log('ðŸŽ¯ Next button clicked, current step:', currentStep);
      e.preventDefault();
      if (await validateStep(currentStep)) {
        console.log('ðŸŽ¯ Validation passed, moving to step:', currentStep + 1);
        currentStep++;
        showStep(currentStep);
      } else {
        console.log('ðŸŽ¯ Validation failed for step:', currentStep);
      }
    });
  } else {
    console.error('ðŸŽ¯ Next button not found!');
  }

  // Previous button
  const prevBtn = document.getElementById('prev-btn');
  if (prevBtn) {
    console.log('ðŸŽ¯ Previous button found, adding event listener');
    prevBtn.addEventListener('click', function(e) {
      console.log('ðŸŽ¯ Previous button clicked');
      e.preventDefault();
      currentStep--;
      showStep(currentStep);
    });
  } else {
    console.log('ðŸŽ¯ Previous button not found (this is normal for step 1)');
  }
});

// Form validation and submission
document.getElementById('registration-form').addEventListener('submit', async function(e) {
  e.preventDefault(); // Always prevent default form submission

  const submitBtn = document.getElementById('submit-btn');

  // Final validation for all steps
  for (let step = 1; step <= totalSteps; step++) {
    if (!(await validateStep(step))) {
      currentStep = step;
      showStep(currentStep);
      return;
    }
  }

  // Disable button and show loading
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creando cuenta...';

  // Submit form programmatically
  const formData = new FormData(this);

  fetch('/api/v1/registrar', {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Success - redirect to login page
      window.location.href = '/login?message=registration_success';
    } else {
      // Error - show error message and re-enable button
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Crear Mi Cuenta Gratuita';

      // Show error message
      const messageDiv = document.getElementById('message');
      const messageContent = document.getElementById('message-content');
      messageDiv.className = 'mt-6';
      messageContent.className = 'p-4 rounded-lg bg-red-50 text-red-800 border border-red-200';
      messageContent.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>' + (data.error || 'Error al crear la cuenta');

      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  })
  .catch(error => {
    console.error('Error submitting form:', error);
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Crear Mi Cuenta Gratuita';

    // Show generic error message
    const messageDiv = document.getElementById('message');
    const messageContent = document.getElementById('message-content');
    messageDiv.className = 'mt-6';
    messageContent.className = 'p-4 rounded-lg bg-red-50 text-red-800 border border-red-200';
    messageContent.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error interno del servidor. IntÃ©ntalo de nuevo.';
  });
});
</script>
{% endblock %}
