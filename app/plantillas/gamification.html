{% extends "base.html" %}

{% block title %}Gamificaci√≥n - Econova{% endblock %}

{% block extra_head %}
<style>
/* ESTILOS ULTRA VISIBLES - PARA ASEGURAR QUE SE VEAN */
body { background: yellow !important; color: black !important; font-size: 20px !important; }

.gamification-container {
  background: red !important;
  border: 10px solid blue !important;
  padding: 20px !important;
  margin: 20px !important;
}

.gamification-hero {
  background: orange !important;
  border: 5px solid purple !important;
  padding: 30px !important;
  margin: 20px 0 !important;
  text-align: center !important;
}

.hero-title {
  color: white !important;
  background: black !important;
  font-size: 40px !important;
  font-weight: bold !important;
  padding: 20px !important;
  border: 3px solid white !important;
}

.hero-subtitle {
  color: blue !important;
  background: yellow !important;
  font-size: 24px !important;
  padding: 15px !important;
  border: 2px solid red !important;
  margin-top: 20px !important;
}

.metrics-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
  gap: 20px !important;
  margin: 30px 0 !important;
}

.metric-card {
  background: green !important;
  border: 4px solid black !important;
  padding: 25px !important;
  text-align: center !important;
  border-radius: 10px !important;
}

.metric-card:hover {
  background: lime !important;
  border-color: white !important;
}

.metric-value {
  font-size: 50px !important;
  font-weight: bold !important;
  color: white !important;
  background: purple !important;
  padding: 15px !important;
  border: 3px solid yellow !important;
  margin-bottom: 15px !important;
}

.metric-label {
  color: black !important;
  background: white !important;
  font-size: 18px !important;
  font-weight: bold !important;
  padding: 8px !important;
  border: 2px solid red !important;
}

.content-layout {
  display: grid !important;
  grid-template-columns: 1fr 400px !important;
  gap: 25px !important;
  margin: 30px 0 !important;
}

.content-card {
  background: cyan !important;
  border: 4px solid magenta !important;
  border-radius: 12px !important;
  margin-bottom: 20px !important;
}

.card-header {
  background: pink !important;
  border-bottom: 3px solid black !important;
  padding: 20px !important;
  text-align: center !important;
}

.card-title {
  font-size: 24px !important;
  font-weight: bold !important;
  color: red !important;
  background: yellow !important;
  padding: 10px !important;
  border: 2px solid blue !important;
}

.card-body {
  padding: 25px !important;
  background: lightblue !important;
}

.btn {
  background: red !important;
  color: white !important;
  border: 3px solid black !important;
  padding: 12px 24px !important;
  font-size: 18px !important;
  font-weight: bold !important;
  cursor: pointer !important;
  border-radius: 8px !important;
  margin: 10px !important;
}

.btn:hover {
  background: darkred !important;
  border-color: white !important;
}

.badges-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
  gap: 15px !important;
}

.badge-card {
  background: magenta !important;
  border: 3px solid cyan !important;
  border-radius: 10px !important;
  padding: 20px !important;
  text-align: center !important;
}

.badge-card:hover {
  background: hotpink !important;
  border-color: white !important;
}

.badge-icon {
  font-size: 40px !important;
  margin-bottom: 15px !important;
  background: yellow !important;
  border: 2px solid red !important;
  padding: 10px !important;
}

.badge-name {
  font-weight: bold !important;
  color: white !important;
  background: black !important;
  padding: 8px !important;
  font-size: 16px !important;
}

.badge-desc {
  color: blue !important;
  background: lightgreen !important;
  padding: 8px !important;
  font-size: 14px !important;
}

.ranking-list {
  background: lightgreen !important;
  border: 3px solid darkgreen !important;
  border-radius: 8px !important;
  padding: 15px !important;
}

.ranking-item {
  background: yellow !important;
  border: 2px solid orange !important;
  border-radius: 6px !important;
  padding: 15px !important;
  margin-bottom: 10px !important;
  display: flex !important;
  align-items: center !important;
  gap: 15px !important;
}

.ranking-item:hover {
  background: gold !important;
  border-color: red !important;
}

.ranking-position {
  width: 50px !important;
  height: 50px !important;
  border-radius: 50% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: bold !important;
  font-size: 18px !important;
  background: white !important;
  border: 3px solid black !important;
}

.ranking-name {
  flex: 1 !important;
  font-weight: bold !important;
  color: blue !important;
  background: lightcyan !important;
  padding: 8px !important;
  font-size: 16px !important;
}

.ranking-score {
  font-weight: bold !important;
  color: red !important;
  background: white !important;
  padding: 8px !important;
  border: 2px solid black !important;
  font-size: 16px !important;
}

.achievements-list {
  background: lightcoral !important;
  border: 3px solid darkred !important;
  border-radius: 8px !important;
  padding: 15px !important;
}

.achievement-item {
  background: white !important;
  border: 2px solid black !important;
  border-radius: 6px !important;
  padding: 20px !important;
  margin-bottom: 15px !important;
}

.achievement-item:hover {
  background: lightyellow !important;
  border-color: red !important;
}

.achievement-name {
  font-weight: bold !important;
  color: blue !important;
  background: lightblue !important;
  padding: 8px !important;
  font-size: 16px !important;
  margin-bottom: 8px !important;
}

.achievement-desc {
  color: green !important;
  background: lightgreen !important;
  padding: 8px !important;
  font-size: 14px !important;
  margin-bottom: 15px !important;
}

.progress-bar {
  width: 100% !important;
  height: 12px !important;
  background: gray !important;
  border-radius: 6px !important;
  overflow: hidden !important;
  margin-bottom: 8px !important;
}

.progress-fill {
  height: 100% !important;
  background: green !important;
  border-radius: 6px !important;
  width: 60% !important;
}

.achievement-progress {
  font-size: 12px !important;
  color: black !important;
  background: yellow !important;
  padding: 4px !important;
  font-weight: bold !important;
}

.activity-list {
  background: lavender !important;
  border: 3px solid purple !important;
  border-radius: 8px !important;
  padding: 15px !important;
}

.activity-item {
  background: white !important;
  border: 2px solid black !important;
  border-radius: 6px !important;
  padding: 15px !important;
  margin-bottom: 12px !important;
  display: flex !important;
  align-items: center !important;
  gap: 15px !important;
}

.activity-item:hover {
  background: lightcyan !important;
  border-color: blue !important;
}

.activity-icon {
  width: 45px !important;
  height: 45px !important;
  border-radius: 50% !important;
  background: orange !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.activity-icon i {
  color: white !important;
  font-size: 16px !important;
}

.activity-text {
  flex: 1 !important;
  font-weight: bold !important;
  color: purple !important;
  background: lightpink !important;
  padding: 8px !important;
  font-size: 14px !important;
}

.activity-time {
  font-size: 12px !important;
  color: red !important;
  background: yellow !important;
  padding: 4px !important;
  margin-top: 5px !important;
}

.activity-points {
  font-weight: bold !important;
  color: green !important;
  background: white !important;
  padding: 8px !important;
  border: 2px solid black !important;
  font-size: 16px !important;
}

.tips-section {
  background: linear-gradient(135deg, blue, green) !important;
  color: white !important;
  border-radius: 12px !important;
  padding: 25px !important;
  border: 4px solid yellow !important;
}

.tips-title {
  font-size: 20px !important;
  font-weight: bold !important;
  color: yellow !important;
  background: black !important;
  padding: 10px !important;
  text-align: center !important;
  margin-bottom: 20px !important;
  border: 2px solid white !important;
}

.tips-list {
  display: flex !important;
  flex-direction: column !important;
  gap: 15px !important;
}

.tips-item {
  display: flex !important;
  align-items: flex-start !important;
  gap: 12px !important;
  padding: 12px !important;
  background: rgba(255,255,255,0.2) !important;
  border-radius: 8px !important;
  border: 2px solid white !important;
}

.tips-item-icon {
  color: yellow !important;
  font-size: 16px !important;
  margin-top: 2px !important;
}

.tips-item-text {
  font-size: 14px !important;
  line-height: 1.5 !important;
  color: white !important;
  background: rgba(0,0,0,0.3) !important;
  padding: 8px !important;
  border-radius: 4px !important;
}

.empty-state {
  text-align: center !important;
  color: blue !important;
  background: lightyellow !important;
  border: 3px solid red !important;
  padding: 40px 20px !important;
  border-radius: 10px !important;
  margin: 20px 0 !important;
}

.empty-state i {
  font-size: 48px !important;
  margin-bottom: 15px !important;
  color: red !important;
  background: yellow !important;
  border: 2px solid black !important;
  padding: 10px !important;
  border-radius: 8px !important;
}

.empty-state h4 {
  font-size: 18px !important;
  font-weight: bold !important;
  color: white !important;
  background: red !important;
  padding: 10px !important;
  border: 2px solid yellow !important;
  margin-bottom: 8px !important;
}

.empty-state p {
  font-size: 14px !important;
  color: black !important;
  background: white !important;
  padding: 8px !important;
  border: 1px solid blue !important;
}

/* RESPONSIVE */
@media (max-width: 1024px) {
  .content-layout { grid-template-columns: 1fr !important; }
  .metrics-grid { grid-template-columns: 1fr !important; }
}

@media (max-width: 768px) {
  .gamification-container { padding: 15px !important; }
  .gamification-hero { padding: 20px !important; }
  .hero-title { font-size: 28px !important; }
  .hero-subtitle { font-size: 16px !important; }
  .metric-card { padding: 15px !important; }
  .metric-value { font-size: 36px !important; }
  .content-layout { gap: 15px !important; }
  .badges-grid { grid-template-columns: 1fr !important; }
}
</style>
{% endblock %}

{% block content %}
<div class="gamification-container">
  <!-- Hero Section -->
  <section class="gamification-hero">
    <div class="hero-icon">
      <i class="fas fa-trophy"></i>
    </div>
    <h1 class="hero-title">Sistema de Gamificaci√≥n</h1>
    <p class="hero-subtitle">¬°Gana puntos, desbloquea insignias y compite con otros usuarios!</p>
  </section>

  <!-- Dashboard de M√©tricas -->
  <section class="metrics-grid">
    <div class="metric-card">
      <div class="metric-icon points">
        <i class="fas fa-star"></i>
      </div>
      <div class="metric-value" id="puntaje-total">{{ estadisticas.puntaje_total or 0 }}</div>
      <div class="metric-label">Puntos Totales</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon level">
        <i class="fas fa-level-up-alt"></i>
      </div>
      <div class="metric-value" id="nivel-actual">{{ (estadisticas.puntaje_total or 0) // 100 + 1 }}</div>
      <div class="metric-label">Nivel Actual</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon badges">
        <i class="fas fa-medal"></i>
      </div>
      <div class="metric-value" id="insignias-total">{{ estadisticas.num_insignias or 0 }}</div>
      <div class="metric-label">Insignias</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon activity">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="metric-value" id="simulaciones-total">{{ estadisticas.num_simulaciones or 0 }}</div>
      <div class="metric-label">Simulaciones</div>
    </div>
  </section>

  <!-- Layout de Contenido -->
  <div class="content-layout">
    <!-- Panel Principal -->
    <div>
      <!-- Insignias -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Mis Insignias</h2>
        </div>
        <div class="card-body">
          <button class="btn" onclick="verificarInsignias()" id="verify-btn">Verificar Nuevas</button>
          <div id="insignias-container" class="badges-grid">
            <!-- Las insignias se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>

      <!-- Ranking -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Ranking Global</h2>
        </div>
        <div class="card-body">
          <div id="ranking-container" class="ranking-list">
            <!-- El ranking se cargar√° aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Panel Lateral -->
    <div>
      <!-- Pr√≥ximos Logros -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Pr√≥ximos Logros</h2>
        </div>
        <div class="card-body">
          <div id="proximos-logros" class="achievements-list">
            <!-- Los logros se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>

      <!-- Actividad Reciente -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Actividad Reciente</h2>
        </div>
        <div class="card-body">
          <div id="actividad-reciente" class="activity-list">
            <!-- La actividad se cargar√° aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>

      <!-- Consejos -->
      <div class="tips-section">
        <h3 class="tips-title">Consejos para Ganar M√°s Puntos</h3>
        <div class="tips-list">
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">Realiza simulaciones financieras (+25 puntos)</p>
          </div>
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">√önete a grupos de benchmarking (+20 puntos)</p>
          </div>
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">Calcula VAN, TIR y otros indicadores (+10 puntos)</p>
          </div>
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">Usa la plataforma diariamente (+5 puntos por login)</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
console.log('üöÄ Gamificaci√≥n: Sistema inicializado');

// Inicializar cuando el DOM est√© cargado
document.addEventListener('DOMContentLoaded', function () {
  console.log('üéØ DOM cargado - Iniciando carga de datos...');
  inicializarGamification();
});

// Funci√≥n principal de inicializaci√≥n
async function inicializarGamification() {
  try {
    // Mostrar indicadores de carga
    mostrarEstadosCarga();

    // Cargar datos en paralelo para mejor performance
    await Promise.all([
      cargarEstadisticas(),
      cargarInsignias(),
      cargarRanking(),
      cargarProximosLogros(),
      cargarActividadReciente()
    ]);

    console.log('‚úÖ Todos los datos cargados exitosamente');
  } catch (error) {
    console.error('‚ùå Error en inicializaci√≥n:', error);
    mostrarErrorGeneral();
  }
}

// Mostrar estados de carga iniciales
function mostrarEstadosCarga() {
  const insigniasContainer = document.getElementById('insignias-container');
  const rankingContainer = document.getElementById('ranking-container');
  const logrosContainer = document.getElementById('proximos-logros');
  const actividadContainer = document.getElementById('actividad-reciente');

  if (insigniasContainer) insigniasContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando insignias...</h4></div>';
  if (rankingContainer) rankingContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando ranking...</h4></div>';
  if (logrosContainer) logrosContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando logros...</h4></div>';
  if (actividadContainer) actividadContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando actividad...</h4></div>';
}

// Mostrar error general
function mostrarErrorGeneral() {
  const containers = ['insignias-container', 'ranking-container', 'proximos-logros', 'actividad-reciente'];

  containers.forEach(id => {
    const container = document.getElementById(id);
    if (container) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h4>Error al cargar datos</h4><p>Por favor intenta nuevamente</p></div>';
    }
  });
}

// Cargar estad√≠sticas del usuario
async function cargarEstadisticas() {
  console.log('üìä Cargando estad√≠sticas...');

  try {
    const response = await fetch('/gamification/api/estadisticas');
    console.log('üìä Respuesta estad√≠sticas:', response.status);

    if (response.status === 401) {
      console.log('üë§ Usuario no autenticado');
      actualizarEstadisticas({ puntaje_total: 0, num_insignias: 0, num_simulaciones: 0 });
      return;
    }

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('üìä Datos estad√≠sticas:', data);

    if (data && data.success) {
      actualizarEstadisticas(data.estadisticas);
    } else {
      console.warn('‚ö†Ô∏è Respuesta de estad√≠sticas no exitosa');
      actualizarEstadisticas({ puntaje_total: 0, num_insignias: 0, num_simulaciones: 0 });
    }
  } catch (error) {
    console.error('‚ùå Error cargando estad√≠sticas:', error);
    actualizarEstadisticas({ puntaje_total: 0, num_insignias: 0, num_simulaciones: 0 });
  }
}

// Actualizar estad√≠sticas en la interfaz
function actualizarEstadisticas(estadisticas) {
  console.log('üìä Actualizando estad√≠sticas:', estadisticas);

  const puntajeTotal = document.getElementById('puntaje-total');
  const nivelActual = document.getElementById('nivel-actual');
  const insigniasTotal = document.getElementById('insignias-total');
  const simulacionesTotal = document.getElementById('simulaciones-total');

  if (puntajeTotal) puntajeTotal.textContent = estadisticas.puntaje_total || 0;
  if (insigniasTotal) insigniasTotal.textContent = estadisticas.num_insignias || 0;
  if (simulacionesTotal) simulacionesTotal.textContent = estadisticas.num_simulaciones || 0;
  if (nivelActual) nivelActual.textContent = Math.floor((estadisticas.puntaje_total || 0) / 100) + 1;
}

// Cargar insignias del usuario
async function cargarInsignias() {
  console.log('üèÜ Cargando insignias...');

  try {
    const response = await fetch('/gamification/api/insignias/usuario');
    console.log('üèÜ Respuesta insignias:', response.status);

    if (response.status === 401) {
      mostrarInsignias([]);
      return;
    }

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('üèÜ Datos insignias:', data);

    if (data && data.success) {
      mostrarInsignias(data.insignias);
    } else {
      console.warn('‚ö†Ô∏è Respuesta de insignias no exitosa');
      mostrarInsignias([]);
    }
  } catch (error) {
    console.error('‚ùå Error cargando insignias:', error);
    mostrarInsignias([]);
  }
}

// Mostrar insignias en la interfaz
function mostrarInsignias(insignias) {
  const container = document.getElementById('insignias-container');
  console.log('üèÜ Mostrando insignias:', insignias.length);

  if (!container) return;

  if (insignias.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-medal"></i>
        <h4>A√∫n no tienes insignias</h4>
        <p>¬°Comienza a usar la plataforma para ganar tus primeras insignias!</p>
      </div>
    `;
    return;
  }

  let html = '';
  insignias.forEach((item, index) => {
    const insignia = item.insignia;
    const fecha = new Date(item.fecha_obtenida).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    html += `
      <div class="badge-card">
        <span class="badge-icon">${insignia.icono || 'üèÜ'}</span>
        <div class="badge-name">${insignia.nombre_insig}</div>
        <p class="badge-desc">${insignia.descripcion_insig}</p>
      </div>
    `;
  });

  container.innerHTML = html;
}

// Cargar ranking global
async function cargarRanking() {
  console.log('üèÖ Cargando ranking...');

  try {
    const response = await fetch(`/gamification/api/ranking/${'General'}`);
    console.log('üèÖ Respuesta ranking:', response.status);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('üèÖ Datos ranking:', data);

    if (data && data.success) {
      mostrarRanking(data.ranking, data.usuarios);
    } else {
      console.warn('‚ö†Ô∏è Respuesta de ranking no exitosa');
      mostrarRanking([], []);
    }
  } catch (error) {
    console.error('‚ùå Error cargando ranking:', error);
    mostrarRanking([], []);
  }
}

// Mostrar ranking en la interfaz
function mostrarRanking(ranking, usuarios) {
  const container = document.getElementById('ranking-container');
  console.log('üèÖ Mostrando ranking:', ranking.length);

  if (!container) return;

  if (ranking.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-trophy"></i>
        <h4>No hay datos de ranking</h4>
        <p>¬°S√© el primero en aparecer en el ranking!</p>
      </div>
    `;
    return;
  }

  let html = '';
  ranking.forEach((item, index) => {
    const posicion = index + 1;
    const usuario = usuarios[index];
    const esUsuarioActual = usuario.nombre_usuario === '{{ session.get("usuario", "") }}';

    let clasePosicion = 'default';
    if (posicion === 1) clasePosicion = 'gold';
    else if (posicion === 2) clasePosicion = 'silver';
    else if (posicion === 3) clasePosicion = 'bronze';

    html += `
      <div class="ranking-item">
        <div class="ranking-position ${clasePosicion}">${posicion}</div>
        <div class="ranking-name">${usuario.nombres} ${usuario.apellidos}</div>
        <div class="ranking-score">${item.puntaje} pts</div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// Cargar pr√≥ximos logros
async function cargarProximosLogros() {
  console.log('üéØ Cargando logros...');

  // Logros simulados
  const proximosLogros = [
    {
      nombre: 'Analista Avanzado',
      descripcion: 'Completa 25 simulaciones financieras',
      progreso: 60
    },
    {
      nombre: 'Benchmarking Experto',
      descripcion: 'Realiza 15 an√°lisis comparativos',
      progreso: 40
    },
    {
      nombre: 'Inversor Estrat√©gico',
      descripcion: 'Optimiza 20 portafolios',
      progreso: 25
    }
  ];

  const container = document.getElementById('proximos-logros');
  if (!container) return;

  let html = '';
  proximosLogros.forEach((logro) => {
    html += `
      <div class="achievement-item">
        <div class="achievement-name">${logro.nombre}</div>
        <p class="achievement-desc">${logro.descripcion}</p>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${logro.progreso}%"></div>
        </div>
        <div class="achievement-progress">${logro.progreso}% completado</div>
      </div>
    `;
  });

  container.innerHTML = html;

  // Animar barras de progreso
  setTimeout(() => {
    const progressBars = container.querySelectorAll('.progress-fill');
    progressBars.forEach((bar, index) => {
      setTimeout(() => {
        bar.style.width = proximosLogros[index].progreso + '%';
      }, index * 300);
    });
  }, 500);
}

// Cargar actividad reciente
async function cargarActividadReciente() {
  console.log('üìÖ Cargando actividad...');

  // Actividad simulada
  const actividades = [
    {
      descripcion: 'Completaste una simulaci√≥n de VAN',
      puntos: '+25',
      tiempo: '2 horas atr√°s',
      icono: 'calculator'
    },
    {
      descripcion: 'Obtuviste la insignia "Primeros Pasos"',
      puntos: '+100',
      tiempo: '1 d√≠a atr√°s',
      icono: 'medal'
    },
    {
      descripcion: 'Inicio de sesi√≥n diario',
      puntos: '+5',
      tiempo: '2 d√≠as atr√°s',
      icono: 'calendar-check'
    }
  ];

  const container = document.getElementById('actividad-reciente');
  if (!container) return;

  let html = '';
  actividades.forEach((actividad) => {
    html += `
      <div class="activity-item">
        <div class="activity-icon">
          <i class="fas fa-${actividad.icono}"></i>
        </div>
        <div class="activity-content">
          <div class="activity-text">${actividad.descripcion}</div>
          <div class="activity-time">${actividad.tiempo}</div>
        </div>
        <div class="activity-points">${actividad.puntos}</div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// Verificar nuevas insignias
async function verificarInsignias() {
  console.log('üîç Verificando insignias...');

  const btn = document.getElementById('verify-btn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
  }

  try {
    const response = await fetch('/gamification/api/verificar-insignias', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    console.log('üîç Respuesta verificaci√≥n:', response.status);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ Resultado verificaci√≥n:', data);

    if (data.success) {
      const mensaje = data.insignias_otorgadas && data.insignias_otorgadas.length > 0 ?
        `¬°${data.insignias_otorgadas.length} nuevas insignias obtenidas!` :
        'No hay nuevas insignias disponibles.';
      alert(mensaje);
      await cargarInsignias();
      await cargarEstadisticas();
    } else {
      alert('Error al verificar insignias');
    }
  } catch (error) {
    console.error('‚ùå Error verificando insignias:', error);
    alert('Error al verificar insignias');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-refresh"></i> Verificar Nuevas';
    }
  }
}
</script>
{% endblock %}
