{% extends "base.html" %}

{% block title %}Gamificaci√≥n - Econova{% endblock %}

{% block extra_head %}
<style>
/* Gamification Styles - Theme Compatible */
.gamification-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.gamification-hero {
  text-align: center;
  margin-bottom: 40px;
}

.hero-title {
  font-size: 2.5rem;
  font-weight: bold;
  color: var(--color-text-primary);
  margin-bottom: 10px;
}

.hero-subtitle {
  font-size: 1.2rem;
  color: var(--color-text-secondary);
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin: 30px 0;
}

.metric-card {
  background: var(--color-card-bg);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  box-shadow: 0 1px 3px var(--color-shadow);
  transition: box-shadow 0.2s;
}

.metric-card:hover {
  box-shadow: 0 4px 6px var(--color-shadow);
}

.metric-value {
  font-size: 2.5rem;
  font-weight: bold;
  color: var(--color-text-primary);
  margin-bottom: 10px;
}

.metric-label {
  color: var(--color-text-secondary);
  font-weight: 500;
}

.content-layout {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 30px;
  margin: 30px 0;
}

.content-card {
  background: var(--color-card-bg);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  box-shadow: 0 1px 3px var(--color-shadow);
  margin-bottom: 20px;
}

.card-header {
  border-bottom: 1px solid var(--color-border);
  padding: 20px;
  text-align: center;
}

.card-title {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--color-text-primary);
}

.card-body {
  padding: 25px;
}

.btn {
  background: var(--color-primary);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn:hover {
  background: #2563eb;
}

.badges-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
}

.badge-card {
  background: var(--color-card-bg);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  transition: box-shadow 0.2s;
}

.badge-card:hover {
  box-shadow: 0 2px 4px var(--color-shadow);
}

.badge-icon {
  font-size: 2rem;
  margin-bottom: 10px;
}

.badge-name {
  font-weight: bold;
  color: var(--color-text-primary);
  margin-bottom: 8px;
}

.badge-desc {
  color: var(--color-text-secondary);
  font-size: 0.9rem;
}

.ranking-list {
  background: var(--color-card-bg);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 15px;
}

.ranking-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  border-bottom: 1px solid var(--color-border);
}

.ranking-item:last-child {
  border-bottom: none;
}

.ranking-position {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
  background: var(--color-surface);
  color: var(--color-text-secondary);
}

.ranking-name {
  flex: 1;
  font-weight: 500;
  color: var(--color-text-primary);
}

.ranking-score {
  font-weight: bold;
  color: var(--color-primary);
}

.achievements-list {
  background: var(--color-card-bg);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 15px;
}

.achievement-item {
  background: var(--color-card-bg);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 15px;
  transition: box-shadow 0.2s;
}

.achievement-item:hover {
  box-shadow: 0 2px 4px var(--color-shadow);
}

.achievement-name {
  font-weight: bold;
  color: var(--color-text-primary);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.achievement-info-icon {
  color: #ffffff !important;
  cursor: pointer !important;
  font-size: 12px !important;
  margin-left: 8px !important;
  transition: all 0.2s !important;
  background: var(--color-primary) !important;
  border-radius: 50% !important;
  width: 16px !important;
  height: 16px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  border: 2px solid #ffffff !important;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
  position: relative !important;
  z-index: 10 !important;
}

.achievement-info-icon:hover {
  background: #2563eb !important;
  transform: scale(1.1) !important;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
}

.tooltip-logro {
  position: absolute !important;
  background: var(--color-card-bg) !important;
  color: var(--color-text-primary) !important;
  padding: 12px !important;
  border-radius: 8px !important;
  font-size: 14px !important;
  line-height: 1.5 !important;
  max-width: 300px !important;
  z-index: 1000 !important;
  box-shadow: 0 10px 25px var(--color-shadow) !important;
  border: 1px solid var(--color-border) !important;
  opacity: 0 !important;
  visibility: hidden !important;
  transition: all 0.3s ease !important;
}

.tooltip-logro.show {
  opacity: 1 !important;
  visibility: visible !important;
}

.tooltip-logro::before {
  content: '' !important;
  position: absolute !important;
  top: -8px !important;
  left: 20px !important;
  width: 0 !important;
  height: 0 !important;
  border-left: 8px solid transparent !important;
  border-right: 8px solid transparent !important;
  border-bottom: 8px solid var(--color-card-bg) !important;
}

.achievement-desc {
  color: var(--color-success) !important;
  background: rgba(34, 197, 94, 0.1) !important;
  padding: 8px !important;
  font-size: 14px !important;
  margin-bottom: 15px !important;
}

.progress-bar {
  width: 100% !important;
  height: 12px !important;
  background: var(--color-progress-bg) !important;
  border-radius: 6px !important;
  overflow: hidden !important;
  margin-bottom: 8px !important;
}

.progress-fill {
  height: 100% !important;
  background: var(--color-progress-fill) !important;
  border-radius: 6px !important;
  width: 60% !important;
}

.achievement-progress {
  font-size: 12px !important;
  color: var(--color-text-secondary) !important;
  background: var(--color-surface) !important;
  padding: 4px !important;
  font-weight: bold !important;
}

.activity-list {
  background: var(--color-card-bg) !important;
  border: 1px solid var(--color-border) !important;
  border-radius: 8px !important;
  padding: 15px !important;
}

.activity-item {
  background: var(--color-surface) !important;
  border: 1px solid var(--color-border) !important;
  border-radius: 6px !important;
  padding: 15px !important;
  margin-bottom: 12px !important;
  display: flex !important;
  align-items: center !important;
  gap: 15px !important;
}

.activity-item:hover {
  background: var(--color-card-bg) !important;
  border-color: var(--color-primary) !important;
}

.activity-icon {
  width: 45px !important;
  height: 45px !important;
  border-radius: 50% !important;
  background: var(--color-primary) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.activity-icon i {
  color: white !important;
  font-size: 16px !important;
}

.activity-text {
  flex: 1 !important;
  font-weight: bold !important;
  color: var(--color-text-primary) !important;
  background: transparent !important;
  padding: 8px !important;
  font-size: 14px !important;
}

.activity-time {
  font-size: 12px !important;
  color: var(--color-text-secondary) !important;
  background: transparent !important;
  padding: 4px !important;
  margin-top: 5px !important;
}

.activity-points {
  font-weight: bold !important;
  color: var(--color-success) !important;
  background: var(--color-surface) !important;
  padding: 8px !important;
  border: 1px solid var(--color-border) !important;
  font-size: 16px !important;
}

.tips-section {
  background: linear-gradient(135deg, var(--color-primary), var(--color-success)) !important;
  color: white !important;
  border-radius: 12px !important;
  padding: 25px !important;
  border: 2px solid var(--color-border) !important;
}

.tips-title {
  font-size: 20px !important;
  font-weight: bold !important;
  color: white !important;
  background: rgba(0,0,0,0.3) !important;
  padding: 10px !important;
  text-align: center !important;
  margin-bottom: 20px !important;
  border: 1px solid rgba(255,255,255,0.3) !important;
}

.tips-list {
  display: flex !important;
  flex-direction: column !important;
  gap: 15px !important;
}

.tips-item {
  display: flex !important;
  align-items: flex-start !important;
  gap: 12px !important;
  padding: 12px !important;
  background: rgba(255,255,255,0.1) !important;
  border-radius: 8px !important;
  border: 1px solid rgba(255,255,255,0.2) !important;
}

.tips-item-icon {
  color: white !important;
  font-size: 16px !important;
  margin-top: 2px !important;
}

.tips-item-text {
  font-size: 14px !important;
  line-height: 1.5 !important;
  color: white !important;
  background: rgba(0,0,0,0.2) !important;
  padding: 8px !important;
  border-radius: 4px !important;
}

.empty-state {
  text-align: center !important;
  color: var(--color-text-primary) !important;
  background: var(--color-surface) !important;
  border: 1px solid var(--color-border) !important;
  padding: 40px 20px !important;
  border-radius: 10px !important;
  margin: 20px 0 !important;
}

.empty-state i {
  font-size: 48px !important;
  margin-bottom: 15px !important;
  color: var(--color-text-secondary) !important;
  background: var(--color-card-bg) !important;
  border: 1px solid var(--color-border) !important;
  padding: 10px !important;
  border-radius: 8px !important;
}

.empty-state h4 {
  font-size: 18px !important;
  font-weight: bold !important;
  color: var(--color-text-primary) !important;
  background: transparent !important;
  padding: 10px !important;
  border: none !important;
  margin-bottom: 8px !important;
}

.empty-state p {
  font-size: 14px !important;
  color: var(--color-text-secondary) !important;
  background: transparent !important;
  padding: 8px !important;
  border: none !important;
}

/* RESPONSIVE */
@media (max-width: 1024px) {
  .content-layout { grid-template-columns: 1fr !important; }
  .metrics-grid { grid-template-columns: 1fr !important; }
}

@media (max-width: 768px) {
  .gamification-container { padding: 15px !important; }
  .gamification-hero { padding: 20px !important; }
  .hero-title { font-size: 28px !important; }
  .hero-subtitle { font-size: 16px !important; }
  .metric-card { padding: 15px !important; }
  .metric-value { font-size: 36px !important; }
  .content-layout { gap: 15px !important; }
  .badges-grid { grid-template-columns: 1fr !important; }
}
</style>
{% endblock %}

{% block content %}
<div class="gamification-container">
  <!-- Hero Section -->
  <section class="gamification-hero">
    <div class="hero-icon">
      <i class="fas fa-trophy"></i>
    </div>
    <h1 class="hero-title">Sistema de Gamificaci√≥n</h1>
    <p class="hero-subtitle">¬°Gana puntos, desbloquea insignias y compite con otros usuarios!</p>
  </section>

  <!-- Dashboard de M√©tricas -->
  <section class="metrics-grid">
    <div class="metric-card">
      <div class="metric-icon points">
        <i class="fas fa-star" style="color: var(--color-primary);"></i>
      </div>
      <div class="metric-value" id="puntaje-total" style="color: var(--color-primary);">{{ estadisticas.puntaje_total or 0 }}</div>
      <div class="metric-label" style="color: var(--color-text-secondary);">Puntos Totales</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon level">
        <i class="fas fa-level-up-alt" style="color: var(--color-warning);"></i>
      </div>
      <div class="metric-value" id="nivel-actual" style="color: var(--color-warning);">{{ (estadisticas.puntaje_total or 0) // 100 + 1 }}</div>
      <div class="metric-label" style="color: var(--color-text-secondary);">Nivel Actual</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon badges">
        <i class="fas fa-medal" style="color: var(--color-success);"></i>
      </div>
      <div class="metric-value" id="insignias-total" style="color: var(--color-success);">{{ estadisticas.num_insignias or 0 }}</div>
      <div class="metric-label" style="color: var(--color-text-secondary);">Insignias</div>
    </div>

    <div class="metric-card">
      <div class="metric-icon activity">
        <i class="fas fa-chart-line" style="color: var(--color-primary);"></i>
      </div>
      <div class="metric-value" id="simulaciones-total" style="color: var(--color-text-primary);">{{ estadisticas.num_simulaciones or 0 }}</div>
      <div class="metric-label" style="color: var(--color-text-secondary);">Simulaciones</div>
    </div>
  </section>

  <!-- Layout de Contenido -->
  <div class="content-layout">
    <!-- Panel Principal -->
    <div>
      <!-- Insignias -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Mis Insignias</h2>
        </div>
        <div class="card-body">
          <button class="btn" onclick="verificarInsignias()" id="verify-btn">Verificar Nuevas</button>
          <div id="insignias-container" class="badges-grid">
            <!-- Las insignias se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>

      <!-- Ranking -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Ranking Global</h2>
        </div>
        <div class="card-body">
          <div id="ranking-container" class="ranking-list">
            <!-- El ranking se cargar√° aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Panel Lateral -->
    <div>
      <!-- Pr√≥ximos Logros -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Pr√≥ximos Logros</h2>
        </div>
        <div class="card-body">
          <div id="proximos-logros" class="achievements-list">
            <!-- Los logros se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>

      <!-- Actividad Reciente -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">Actividad Reciente</h2>
        </div>
        <div class="card-body">
          <div id="actividad-reciente" class="activity-list">
            <!-- La actividad se cargar√° aqu√≠ din√°micamente -->
          </div>
        </div>
      </div>

      <!-- Consejos -->
      <div class="tips-section">
        <h3 class="tips-title">Consejos para Ganar M√°s Puntos</h3>
        <div class="tips-list">
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">Realiza simulaciones financieras (+25 puntos)</p>
          </div>
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">√önete a grupos de benchmarking (+20 puntos)</p>
          </div>
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">Calcula VAN, TIR y otros indicadores (+10 puntos)</p>
          </div>
          <div class="tips-item">
            <i class="fas fa-check-circle"></i>
            <p class="tips-item-text">Usa la plataforma diariamente (+5 puntos por login)</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
console.log('üöÄ Gamificaci√≥n: Sistema inicializado');

// Inicializar cuando el DOM est√© cargado
document.addEventListener('DOMContentLoaded', function () {
  console.log('üéØ DOM cargado - Iniciando carga de datos...');
  inicializarGamification();

  // Escuchar eventos de actividad reciente
  document.addEventListener('actividadRecienteActualizada', function(event) {
    console.log('üìÖ Actividad reciente actualizada:', event.detail);
    actualizarActividadReciente(event.detail);
  });

  // Escuchar eventos de progreso de logros
  document.addEventListener('gamificationProgresoActualizado', function(event) {
    console.log('üìä EVENTO RECIBIDO: Progreso de logros actualizado:', event.detail);
    console.log('üîÑ Recargando logros...');
    // Recargar los pr√≥ximos logros para mostrar el progreso actualizado
    cargarProximosLogros();
  });

  // Escuchar cualquier evento de gamificaci√≥n para debugging
  document.addEventListener('gamificationPuntosOtorgados', function(event) {
    console.log('üí∞ EVENTO RECIBIDO: Puntos otorgados:', event.detail);
  });

  document.addEventListener('gamificationInsigniaObtenida', function(event) {
    console.log('üèÜ EVENTO RECIBIDO: Insignia obtenida:', event.detail);
  });
});

// Funci√≥n principal de inicializaci√≥n
async function inicializarGamification() {
  try {
    // Mostrar indicadores de carga
    mostrarEstadosCarga();

    // Cargar datos en paralelo para mejor performance
    await Promise.all([
      cargarEstadisticas(),
      cargarInsignias(),
      cargarRanking(),
      cargarProximosLogros(),
      cargarActividadReciente()
    ]);

    console.log('‚úÖ Todos los datos cargados exitosamente');
  } catch (error) {
    console.error('‚ùå Error en inicializaci√≥n:', error);
    mostrarErrorGeneral();
  }
}

// Mostrar estados de carga iniciales
function mostrarEstadosCarga() {
  const insigniasContainer = document.getElementById('insignias-container');
  const rankingContainer = document.getElementById('ranking-container');
  const logrosContainer = document.getElementById('proximos-logros');
  const actividadContainer = document.getElementById('actividad-reciente');

  if (insigniasContainer) insigniasContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando insignias...</h4></div>';
  if (rankingContainer) rankingContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando ranking...</h4></div>';
  if (logrosContainer) logrosContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando logros...</h4></div>';
  if (actividadContainer) actividadContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h4>Cargando actividad...</h4></div>';
}

// Mostrar error general
function mostrarErrorGeneral() {
  const containers = ['insignias-container', 'ranking-container', 'proximos-logros', 'actividad-reciente'];

  containers.forEach(id => {
    const container = document.getElementById(id);
    if (container) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h4>Error al cargar datos</h4><p>Por favor intenta nuevamente</p></div>';
    }
  });
}

// Cargar estad√≠sticas del usuario
async function cargarEstadisticas() {
  console.log('üìä Cargando estad√≠sticas...');

  try {
    const response = await fetch('/gamification/api/estadisticas');
    console.log('üìä Respuesta estad√≠sticas:', response.status);

    if (response.status === 401) {
      console.log('üë§ Usuario no autenticado');
      actualizarEstadisticas({ puntaje_total: 0, num_insignias: 0, num_simulaciones: 0 });
      return;
    }

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('üìä Datos estad√≠sticas:', data);

    if (data && data.success) {
      actualizarEstadisticas(data.estadisticas);
    } else {
      console.warn('‚ö†Ô∏è Respuesta de estad√≠sticas no exitosa');
      actualizarEstadisticas({ puntaje_total: 0, num_insignias: 0, num_simulaciones: 0 });
    }
  } catch (error) {
    console.error('‚ùå Error cargando estad√≠sticas:', error);
    actualizarEstadisticas({ puntaje_total: 0, num_insignias: 0, num_simulaciones: 0 });
  }
}

// Actualizar estad√≠sticas en la interfaz
function actualizarEstadisticas(estadisticas) {
  console.log('üìä Actualizando estad√≠sticas:', estadisticas);

  const puntajeTotal = document.getElementById('puntaje-total');
  const nivelActual = document.getElementById('nivel-actual');
  const insigniasTotal = document.getElementById('insignias-total');
  const simulacionesTotal = document.getElementById('simulaciones-total');

  if (puntajeTotal) puntajeTotal.textContent = estadisticas.puntaje_total || 0;
  if (insigniasTotal) insigniasTotal.textContent = estadisticas.num_insignias || 0;
  if (simulacionesTotal) simulacionesTotal.textContent = estadisticas.num_simulaciones || 0;
  if (nivelActual) nivelActual.textContent = Math.floor((estadisticas.puntaje_total || 0) / 100) + 1;
}

// Cargar insignias del usuario
async function cargarInsignias() {
  console.log('üèÜ Cargando insignias...');

  try {
    const response = await fetch('/gamification/api/insignias/usuario');
    console.log('üèÜ Respuesta insignias:', response.status);

    if (response.status === 401) {
      mostrarInsignias([]);
      return;
    }

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('üèÜ Datos insignias:', data);

    if (data && data.success) {
      mostrarInsignias(data.insignias);
    } else {
      console.warn('‚ö†Ô∏è Respuesta de insignias no exitosa');
      mostrarInsignias([]);
    }
  } catch (error) {
    console.error('‚ùå Error cargando insignias:', error);
    mostrarInsignias([]);
  }
}

// Mostrar insignias en la interfaz
function mostrarInsignias(insignias) {
  const container = document.getElementById('insignias-container');
  console.log('üèÜ Mostrando insignias:', insignias.length);

  if (!container) return;

  if (insignias.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-medal"></i>
        <h4>A√∫n no tienes insignias</h4>
        <p>¬°Comienza a usar la plataforma para ganar tus primeras insignias!</p>
      </div>
    `;
    return;
  }

  let html = '';
  insignias.forEach((item, index) => {
    const insignia = item.insignia;
    const fecha = new Date(item.fecha_obtenida).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    html += `
      <div class="badge-card">
        <span class="badge-icon">${insignia.icono || 'üèÜ'}</span>
        <div class="badge-name">${insignia.nombre_insig}</div>
        <p class="badge-desc">${insignia.descripcion_insig}</p>
      </div>
    `;
  });

  container.innerHTML = html;
}

// Cargar ranking global
async function cargarRanking() {
  console.log('üèÖ Cargando ranking...');

  try {
    const response = await fetch(`/gamification/api/ranking/${'General'}`);
    console.log('üèÖ Respuesta ranking:', response.status);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('üèÖ Datos ranking:', data);

    if (data && data.success) {
      mostrarRanking(data.ranking, data.usuarios);
    } else {
      console.warn('‚ö†Ô∏è Respuesta de ranking no exitosa');
      mostrarRanking([], []);
    }
  } catch (error) {
    console.error('‚ùå Error cargando ranking:', error);
    mostrarRanking([], []);
  }
}

// Mostrar ranking en la interfaz
function mostrarRanking(ranking, usuarios) {
  const container = document.getElementById('ranking-container');
  console.log('üèÖ Mostrando ranking:', ranking.length);

  if (!container) return;

  if (ranking.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-trophy"></i>
        <h4>No hay datos de ranking</h4>
        <p>¬°S√© el primero en aparecer en el ranking!</p>
      </div>
    `;
    return;
  }

  let html = '';
  ranking.forEach((item, index) => {
    const posicion = index + 1;
    const usuario = usuarios[index];
    const esUsuarioActual = usuario.nombre_usuario === '{{ session.get("usuario", "") }}';

    let clasePosicion = 'default';
    if (posicion === 1) clasePosicion = 'gold';
    else if (posicion === 2) clasePosicion = 'silver';
    else if (posicion === 3) clasePosicion = 'bronze';

    html += `
      <div class="ranking-item">
        <div class="ranking-position ${clasePosicion}">${posicion}</div>
        <div class="ranking-name">${usuario.nombres} ${usuario.apellidos}</div>
        <div class="ranking-score">${item.puntaje} pts</div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// Cargar pr√≥ximos logros
async function cargarProximosLogros() {
  console.log('üéØ Cargando logros...');

  const container = document.getElementById('proximos-logros');
  if (!container) {
    console.log('‚ùå No se encontr√≥ el contenedor de logros');
    return;
  }

  // Mostrar logros por defecto inmediatamente
  const proximosLogros = [
    {
      nombre: 'Analista Avanzado',
      descripcion: 'Ve a la secci√≥n "Simulaciones" y completa 25 an√°lisis financieros diferentes',
      progreso: 0
    },
    {
      nombre: 'Benchmarking Experto',
      descripcion: 'Realiza 15 an√°lisis de benchmarking (sectorial o personalizado)',
      progreso: 0
    },
    {
      nombre: 'Optimizador',
      descripcion: 'Ve a "Portafolio" en Calculadoras y encuentra la mejor combinaci√≥n de activos (10 optimizaciones)',
      progreso: 0
    },
    {
      nombre: 'L√≠der de Sector',
      descripcion: '√önete a grupos de benchmarking y alcanza el top 3 en tu sector',
      progreso: 0
    },
    {
      nombre: 'Innovador',
      descripcion: 'Crea estrategias √∫nicas combinando diferentes herramientas financieras (5 estrategias)',
      progreso: 0
    },
    {
      nombre: 'Experto en VAN',
      descripcion: 'Ve a "VAN" en Calculadoras y calcula el VAN en m√°s de 10 proyectos',
      progreso: 0
    },
    {
      nombre: 'Maestro TIR',
      descripcion: 'Ve a "TIR" en Calculadoras y domina escenarios complejos de retorno',
      progreso: 0
    }
  ];

  let html = '';
  proximosLogros.forEach((logro, index) => {
    console.log(`üéØ Agregando logro: ${logro.nombre} con √≠cono`);
    html += `
      <div class="achievement-item">
        <div class="achievement-name">
          ${logro.nombre}
          <i class="fas fa-info-circle achievement-info-icon"
             data-tooltip="${logro.descripcion}"
             onclick="mostrarTooltipLogro(${index}, '${logro.descripcion.replace(/'/g, "\\'")}')"
             title="Haz clic para ver instrucciones"></i>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${logro.progreso}%"></div>
        </div>
        <div class="achievement-progress">${logro.progreso}% completado</div>
      </div>
    `;
  });

  container.innerHTML = html;

  // Intentar cargar estad√≠sticas reales para actualizar progreso
  try {
    console.log('üìä Intentando cargar estad√≠sticas para actualizar progreso...');

    const response = await fetch('/gamification/api/estadisticas');
    const accionesUsuario = JSON.parse(localStorage.getItem('econova_acciones') || '{}');

    if (response.ok) {
      const data = await response.json();
      if (data.success && data.estadisticas) {
        console.log('‚úÖ Estad√≠sticas cargadas, actualizando progreso...');

        // Actualizar progreso basado en datos reales
        proximosLogros[0].progreso = Math.min(100, Math.round((accionesUsuario.simulacion_completada || data.estadisticas.num_simulaciones || 0) / 25 * 100));
        proximosLogros[1].progreso = Math.min(100, Math.round((accionesUsuario.benchmarking_realizado || data.estadisticas.num_benchmarking || 0) / 15 * 100));
        proximosLogros[2].progreso = Math.min(100, Math.round((accionesUsuario.portafolio_optimizado || 0) / 10 * 100));
        proximosLogros[3].progreso = Math.min(100, Math.round((accionesUsuario.grupo_unido || 0) / 3 * 100));
        proximosLogros[4].progreso = Math.min(100, Math.round((accionesUsuario.estrategia_creada || 0) / 5 * 100));
        proximosLogros[5].progreso = Math.min(100, Math.round((accionesUsuario.calculo_van || data.estadisticas.num_calculos_van || 0) / 10 * 100));
        proximosLogros[6].progreso = Math.min(100, Math.round((accionesUsuario.calculo_tir || data.estadisticas.num_calculos_tir || 0) / 10 * 100));

        // Actualizar HTML con progreso real
        let updatedHtml = '';
        proximosLogros.forEach((logro, index) => {
          updatedHtml += `
            <div class="achievement-item">
              <div class="achievement-name">
                ${logro.nombre}
                <i class="fas fa-info-circle achievement-info-icon"
                   onclick="mostrarTooltipLogro(${index}, '${logro.descripcion.replace(/'/g, "\\'")}')"></i>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${logro.progreso}%"></div>
              </div>
              <div class="achievement-progress">${logro.progreso}% completado</div>
            </div>
          `;
        });

        container.innerHTML = updatedHtml;

        // Re-animar barras de progreso
        setTimeout(() => {
          const progressBars = container.querySelectorAll('.progress-fill');
          progressBars.forEach((bar, index) => {
            setTimeout(() => {
              bar.style.width = proximosLogros[index].progreso + '%';
            }, index * 100);
          });
        }, 200);
      }
    }
  } catch (error) {
    console.log('‚ö†Ô∏è No se pudieron cargar estad√≠sticas, manteniendo valores por defecto:', error);
    // Mantener valores por defecto si hay error
  }

  console.log('‚úÖ Logros cargados exitosamente');
}

// Cargar actividad reciente
async function cargarActividadReciente() {
  console.log('üìÖ Cargando actividad...');

  // Actividad simulada
  const actividades = [
    {
      descripcion: 'Completaste una simulaci√≥n de VAN',
      puntos: '+25',
      tiempo: '2 horas atr√°s',
      icono: 'calculator'
    },
    {
      descripcion: 'Obtuviste la insignia "Primeros Pasos"',
      puntos: '+100',
      tiempo: '1 d√≠a atr√°s',
      icono: 'medal'
    },
    {
      descripcion: 'Inicio de sesi√≥n diario',
      puntos: '+5',
      tiempo: '2 d√≠as atr√°s',
      icono: 'calendar-check'
    }
  ];

  const container = document.getElementById('actividad-reciente');
  if (!container) return;

  let html = '';
  actividades.forEach((actividad) => {
    html += `
      <div class="activity-item">
        <div class="activity-icon">
          <i class="fas fa-${actividad.icono}"></i>
        </div>
        <div class="activity-content">
          <div class="activity-text">${actividad.descripcion}</div>
          <div class="activity-time">${actividad.tiempo}</div>
        </div>
        <div class="activity-points">${actividad.puntos}</div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// Funci√≥n para mostrar tooltip de logro
function mostrarTooltipLogro(index, descripcion) {
  // Ocultar tooltips existentes
  const tooltipsExistentes = document.querySelectorAll('.tooltip-logro');
  tooltipsExistentes.forEach(tooltip => tooltip.remove());

  // Crear nuevo tooltip
  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip-logro';
  tooltip.innerHTML = descripcion;

  // Posicionar el tooltip
  const icono = document.querySelectorAll('.achievement-info-icon')[index];
  if (icono) {
    const rect = icono.getBoundingClientRect();
    tooltip.style.left = (rect.left - 150) + 'px'; // Centrar sobre el √≠cono
    tooltip.style.top = (rect.top - 50) + 'px'; // Arriba del √≠cono
  }

  document.body.appendChild(tooltip);

  // Mostrar con animaci√≥n
  setTimeout(() => {
    tooltip.classList.add('show');
  }, 10);

  // Ocultar al hacer clic fuera
  const ocultarTooltip = (e) => {
    if (!tooltip.contains(e.target) && e.target !== icono) {
      tooltip.classList.remove('show');
      setTimeout(() => {
        if (tooltip.parentNode) {
          tooltip.parentNode.removeChild(tooltip);
        }
      }, 300);
      document.removeEventListener('click', ocultarTooltip);
    }
  };

  setTimeout(() => {
    document.addEventListener('click', ocultarTooltip);
  }, 100);

  // Auto-ocultar despu√©s de 5 segundos
  setTimeout(() => {
    if (tooltip.parentNode) {
      tooltip.classList.remove('show');
      setTimeout(() => {
        if (tooltip.parentNode) {
          tooltip.parentNode.removeChild(tooltip);
        }
      }, 300);
    }
  }, 5000);
}

// Funci√≥n para actualizar actividad reciente din√°micamente
function actualizarActividadReciente(actividad) {
  console.log('üìÖ Actualizando actividad reciente:', actividad);

  const container = document.getElementById('actividad-reciente');
  if (!container) return;

  // Crear nueva actividad
  const nuevaActividad = document.createElement('div');
  nuevaActividad.className = 'activity-item';
  nuevaActividad.innerHTML = `
    <div class="activity-icon" style="background: ${actividad.color || '#9C27B0'} !important;">
      <i class="fas fa-${actividad.icono || 'star'}"></i>
    </div>
    <div class="activity-content">
      <div class="activity-text">${actividad.descripcion}</div>
      <div class="activity-time">Ahora mismo</div>
    </div>
    <div class="activity-points">+20</div>
  `;

  // Agregar al inicio de la lista
  if (container.firstChild) {
    container.insertBefore(nuevaActividad, container.firstChild);
  } else {
    container.appendChild(nuevaActividad);
  }

  // Mantener m√°ximo 10 actividades
  while (container.children.length > 10) {
    container.removeChild(container.lastChild);
  }

  console.log('‚úÖ Actividad reciente actualizada');
}

// Verificar nuevas insignias
async function verificarInsignias() {
  console.log('üîç Verificando insignias...');

  const btn = document.getElementById('verify-btn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
  }

  try {
    const response = await fetch('/gamification/api/verificar-insignias', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    console.log('üîç Respuesta verificaci√≥n:', response.status);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ Resultado verificaci√≥n:', data);

    if (data.success) {
      const mensaje = data.insignias_otorgadas && data.insignias_otorgadas.length > 0 ?
        `¬°${data.insignias_otorgadas.length} nuevas insignias obtenidas!` :
        'No hay nuevas insignias disponibles.';
      alert(mensaje);
      await cargarInsignias();
      await cargarEstadisticas();
    } else {
      alert('Error al verificar insignias');
    }
  } catch (error) {
    console.error('‚ùå Error verificando insignias:', error);
    alert('Error al verificar insignias');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-refresh"></i> Verificar Nuevas';
    }
  }
}
</script>
{% endblock %}
